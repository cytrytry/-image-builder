FROM ccr-2vdh3abv-pub.cnc.bj.baidubce.com/paddlepaddle/paddlex-genai-vllm-server:latest
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1



# install jupyter
RUN pip install jupyter nvitop  

COPY jupyter/jupyter.sh   /opt/supervisor/jupyter.sh
COPY jupyter/jupyter.conf /etc/supervisor/conf.d/jupyter.conf

WORKDIR /root
# 创建虚拟环境

RUN python -m venv .venv
# 设置环境变量，让后续命令自动使用虚拟环境
ENV PATH="/root/.venv/bin:$PATH"

# 使用虚拟环境安装依赖
RUN pip install paddlepaddle-gpu==3.2.0 -i https://www.paddlepaddle.org.cn/packages/stable/cu126/

RUN pip install -U "paddleocr[doc-parser]"

RUN pip install https://paddle-whl.bj.bcebos.com/nightly/cu126/safetensors/safetensors-0.6.2.dev0-cp38-abi3-linux_x86_64.whl
# 使用虚拟环境中的 paddlex
RUN paddlex --install genai-client

RUN echo "" | paddlex --get_pipeline_config PaddleOCR-VL

# 修改配置文件
RUN sed -i 's/backend:.*/backend: vllm-server/' PaddleOCR-VL.yaml && \
    sed -i '/backend: vllm-server/a\      server_url: http://127.0.0.1:8118/v1' PaddleOCR-VL.yaml
# 复制 paddleocr-vl 配置文件
COPY paddleocr-vl/paddleocr-vl.sh   /opt/supervisor/paddleocr-vl.sh
COPY paddleocr-vl/paddleocr-vl.conf /etc/supervisor/conf.d/paddleocr-vl.conf


CMD  ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]