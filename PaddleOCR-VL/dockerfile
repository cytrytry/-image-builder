FROM ccr-2vdh3abv-pub.cnc.bj.baidubce.com/paddlepaddle/paddlex-genai-vllm-server:latest
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1


WORKDIR /root
# 创建虚拟环境

RUN python -m venv .venv
# 设置环境变量，让后续命令自动使用虚拟环境
ENV PATH="/root/.venv/bin:$PATH"

# 使用虚拟环境安装依赖
RUN pip install paddlepaddle-gpu==3.2.0 -i https://www.paddlepaddle.org.cn/packages/stable/cu126/

RUN pip install -U "paddleocr[doc-parser]"

RUN pip install https://paddle-whl.bj.bcebos.com/nightly/cu126/safetensors/safetensors-0.6.2.dev0-cp38-abi3-linux_x86_64.whl
# 使用虚拟环境中的 paddlex
RUN paddlex --install genai-client

RUN echo "" | paddlex --get_pipeline_config PaddleOCR-VL

# 修改配置文件
RUN sed -i 's/backend:.*/backend: vllm-server/' PaddleOCR-VL.yaml && \
    sed -i '/backend: vllm-server/a\      server_url: http://127.0.0.1:8118/v1' PaddleOCR-VL.yaml



CMD ["paddlex_genai_server", "--model_name", "PaddleOCR-VL-0.9B", "--host", "0.0.0.0", "--port", "8118", "--backend", "vllm"]