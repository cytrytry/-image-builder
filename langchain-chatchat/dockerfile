# 基础镜像
FROM python:3.11
LABEL maintainer=Langchain-Chatchat
WORKDIR /root

# 环境变量
ENV CHATCHAT_ROOT=/root/chatchat_data

# 初始化环境
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone
RUN apt-get update -y && \
    apt-get install -y git && \
    apt-get install -y --no-install-recommends libgl1 libglib2.0-0 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
RUN pip install --upgrade pip setuptools
RUN pip install --index-url https://pypi.python.org/simple/ pipx && \
    pipx install poetry --force

# Add poetry to PATH
ENV PATH="/root/.local/bin:${PATH}"

# 下载 Langchain-Chatchat
RUN git clone https://github.com/chatchat-space/Langchain-Chatchat.git

# 安装依赖
WORKDIR /root/Langchain-Chatchat/libs/chatchat-server
RUN poetry config virtualenvs.create false
RUN poetry install --with lint,test -E xinference

## 确保 Python 可以找到 chatchat 模块
ENV PYTHONPATH="/root/Langchain-Chatchat/libs/chatchat-server:${PYTHONPATH}"

# 初始化配置
WORKDIR /root/Langchain-Chatchat/libs/chatchat-server/chatchat
RUN python cli.py init

WORKDIR /root
RUN python -m venv /root/xinference
RUN /root/xinference/bin/pip install "xinference[all]"

# 创建启动脚本，同时启动 xinference 和 langchain
RUN cat > /root/start.sh << 'EOF'
#!/bin/bash
set -e

# 启动 xinference 服务（使用虚拟环境 /root/xinference，后台运行）
/root/xinference/bin/xinference-local --host 0.0.0.0 --port 9997 &
XINFERENCE_PID=$!
echo "Xinference started with PID: $XINFERENCE_PID"

# 等待 xinference 启动
sleep 5

# 定义清理函数
cleanup() {
    echo "Shutting down services..."
    kill $XINFERENCE_PID 2>/dev/null || true
    exit 0
}

# 捕获退出信号
trap cleanup SIGTERM SIGINT

# 启动 langchain 服务（前台运行，保持容器运行）
cd /root/Langchain-Chatchat/libs/chatchat-server/chatchat
exec python cli.py start -a
EOF
RUN chmod +x /root/start.sh

EXPOSE 7861 8501 9997
ENTRYPOINT ["/root/start.sh"]